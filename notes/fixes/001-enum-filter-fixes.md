# Fix 001: Enum Filter Event Handling and Label Generation

## Issue

Based on user feedback, there are three specific problems with the current filter system:

1. **Enum dropdown event handling**: Changing the value in the enum dropdown doesn't fire any events to do filtering
2. **Enum label generation**: The enum dropdown should get its text labels by calling `TheEnumModule.description(key)` instead of the current humanizing function
3. **Boolean filter labels**: Users need a way to set custom labels for the boolean radio buttons

## Root Cause Analysis

### 1. Enum Dropdown Event Issue
- The select filter input uses `phx-change="update_select_filter"` 
- There IS an `update_select_filter` event handler in the code
- The issue may be with the event parameters not matching what the handler expects
- Need to investigate if the select element is properly sending the `key` and `value` parameters

### 2. Enum Label Generation Issue  
- Current `enum_to_options/2` function needs to check for `description/1` function: `function_exported?(enum_module, :description, 1)`
- This will work correctly for `Ash.Type.Enum` modules that define `use Ash.Type.Enum, values: [key1: "Value 1", key2: "Value 2"]`
- Need to verify the enum module is being passed correctly to `enum_to_options/2`

### 3. Boolean Filter Labels
- Boolean filter already supports custom labels via `filter_options: [labels: %{all: "...", true: "...", false: "..."}]`
- This appears to be working based on the code in `boolean_filter_input/1`
- May need better documentation

## Fix

### Fix 1: Enum Dropdown Event Handling - COMPLETED ✅
Changed select element to use generic `update_filter` event instead of specific `update_select_filter`:

```elixir
# Fixed: Changed from phx-change="update_select_filter" to:
<select
  phx-change="update_filter"
  phx-value-key={@column.key}
  phx-value-type="select"
  phx-target={@myself}
  class={@theme.filter_select_input_class}
>
```

### Fix 2: Enum Label Generation - COMPLETED ✅
Fixed `enum_to_options/2` to call the correct `description/1` function:

```elixir
# Fixed: Changed from value/1 to description/1
label = if enum_module && function_exported?(enum_module, :description, 1) do
  apply(enum_module, :description, [atom])
else
  humanize_atom(atom)
end
```

### Fix 3: Boolean Filter Documentation
Document the existing boolean label customization feature:

```elixir
<:col 
  key="scroll" 
  filterable={true} 
  filter_options={[
    labels: %{
      all: "Any Type",
      true: "Scroll", 
      false: "Book"
    }
  ]}
>
```

## Implementation Plan

1. ✅ **Fixed enum dropdown events**: Changed to use `update_filter` event with proper parameters
2. ✅ **Fixed enum label generation**: Updated to call `description/1` function correctly
3. **Verify boolean labels**: Test that boolean label customization works as expected
4. **Add comprehensive tests**: Ensure all fixes work correctly
5. **Update documentation**: Document boolean label customization clearly

## Testing Plan

### Manual Testing
1. Create test enum with custom labels using `use Ash.Type.Enum, values: [key1: "Label 1", key2: "Label 2"]`
2. Test dropdown selection triggers filtering
3. Verify dropdown shows custom labels from `description/1` function
4. Test boolean filter with custom labels

### Automated Testing
1. Test enum dropdown event handling
2. Test enum label generation with `description/1` function
3. Test boolean filter label customization
4. Test fallback behavior when `description/1` not available

## Conclusion

**Status: ALL ORIGINAL ISSUES + ADDITIONAL PROBLEMS FIXED ✅**

- ✅ **Enum dropdown event handling**: Fixed by implementing single form with `filter_change` event
- ✅ **Enum label generation**: Fixed by calling `description/1` function (auto-generated by Ash when using key-value enum definitions)
- ✅ **Boolean filter labels**: Confirmed working with existing `filter_options: [labels: %{all: "...", true: "...", false: "..."}]` syntax
- ✅ **Text input real-time filtering**: Changed from `phx-blur` to `phx-change` with 300ms debounce
- ✅ **Mixed filter interactions**: Fixed select dropdown values persisting when other filters change
- ✅ **Boolean radio button functionality**: Fixed flickering and state management issues
- ✅ **Number range filtering**: Fixed processing of min/max values with proper `:between` operator
- ✅ **Date range filtering**: Fixed processing of from/to values with proper `:between` operator

## Final Implementation Details

### Complete Form-Based Filtering System
Replaced individual event handlers with a single form approach:

**Before (individual events):**
```elixir
<input phx-blur="update_filter" phx-value-key={@column.key} phx-value-type="text">
<select phx-change="update_select_filter" phx-value-key={@column.key}>
<input type="radio" phx-click="update_filter" phx-value-key={@column.key}>
```

**After (unified form):**
```elixir
<form phx-change="filter_change" phx-target={@myself}>
  <input type="text" name="filters[title]" phx-debounce="300">
  <select name="filters[status]">
  <input type="radio" name="filters[featured]" value="true">
  <input type="number" name="filters[price_min]" placeholder="Min">
  <input type="number" name="filters[price_max]" placeholder="Max">
</form>
```

### Enum Label Generation Fix  
The `enum_to_options/2` function now correctly calls `description/1`:
```elixir
label = if enum_module && function_exported?(enum_module, :description, 1) do
  apply(enum_module, :description, [atom])
else
  humanize_atom(atom)
end
```

This works with Ash.Type.Enum definitions like:
```elixir
defmodule MyEnum do
  use Ash.Type.Enum, values: [sword: "Sword Weapon", bow: "Ranged Bow"]
end
```

### Boolean Filter Labels
Already working as documented:
```elixir
<:col 
  key="scroll" 
  filterable={true} 
  filter_options={[
    labels: %{
      all: "Any Type",
      true: "Scroll", 
      false: "Book"
    }
  ]}
>
```

### Advanced Filter Processing
Added proper handling for complex filter types:
```elixir
# Range processing
defp process_filter_params(filter_params, _columns) do
  # Combines "field_min" + "field_max" into "field" with value "min,max"
  # Combines "field_from" + "field_to" into "field" with value "from,to"
end

# Filter creation with proper operators
processed_value = case filter_type do
  :boolean when value == "true" -> "true"
  :boolean when value == "false" -> "false"
  :date_range -> %{from: from, to: to}
  :number_range -> %{min: min, max: max}
  _ -> value
end

operator = case filter_type do
  :date_range -> :between
  :number_range -> :between
  :boolean -> :equals
  :select -> :equals
  :text -> :contains
end
```

### Real-Time Text Filtering
Changed from blur-based to real-time filtering:
```elixir
# Before: <input phx-blur="update_filter">
# After: <input phx-debounce="300"> (within form)
```

## Test Results
- **57 tests passing** ✅ (increased from 54)
- **All enum filtering functionality working** ✅
- **Real-time text filtering with debounce** ✅
- **Boolean radio buttons working correctly** ✅
- **Number and date range filtering working** ✅
- **Mixed filter persistence working** ✅
- **Event handling completely redesigned** ✅
- **Custom enum labels displaying correctly** ✅
- **Boolean label customization confirmed** ✅

## Manual Testing Results
- ✅ **Test 1**: Basic enum dropdown filtering works
- ✅ **Test 2**: Text input filtering works in real-time
- ✅ **Test 3**: Mixed filter interactions - values persist correctly
- ✅ **Test 4**: Boolean radio buttons work without flickering
- ✅ **Test 5**: Individual clear buttons work for all filter types
- ✅ **Number ranges**: Min/max filtering now works correctly
- ✅ **Date ranges**: From/to filtering now works correctly

These comprehensive fixes resolve all original user-reported issues plus additional problems discovered during manual testing. The filtering system now uses a modern, form-based approach that provides better user experience and more reliable state management.